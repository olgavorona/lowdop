---
status: planned
depends_on: [4]
wave: 3
skills: [code-writing]
verify:
reviewers: [code-reviewer]
teammate_name:
---

# Task 8: BookshelfView + ContentView navigation

## Required Skills

Before executing, load:
- `/skill:code-writing` — [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Create a new BookshelfView screen and integrate it into the ContentView navigation state machine. The current navigation is binary: `Onboarding -> Grid`. This task adds BookshelfView as an intermediate screen, making the flow: `Onboarding -> Bookshelf -> Grid`.

BookshelfView shows pack card(s) in a bookshelf-style layout designed for iPad landscape. For now there is only one pack ("Ocean Adventures"), but the view must be structured to support multiple packs in the future. Each pack card displays the pack title, a visual theme, and completion progress. Tapping a pack navigates to the LabyrinthGridView for that pack's stories at the user's selected difficulty.

ContentView currently uses a simple boolean `preferences.hasCompletedOnboarding` to decide between OnboardingView and LabyrinthGridView. This must be extended to a three-state navigation model: onboarding, bookshelf, and grid. The bookshelf state is reached after onboarding completes, and the grid state is reached when a pack is selected from the bookshelf.

The visual design must follow the app's low-stimulation aesthetic: warm cream background (`#FFF8E7`), rounded corners, brown text (`#5D4E37`), gentle shadows, child-friendly layout.

## What to do

1. **Create `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/BookshelfView.swift`**:
   - A SwiftUI view that shows available packs as cards in a bookshelf layout
   - For now, hardcode a single pack representing "Ocean Adventures" (stories 1-20)
   - Use `LabyrinthLoader.shared.loadStories()` (from task 4) to get story metadata for the pack
   - Each pack card shows: pack title ("Ocean Adventures"), a cover visual (e.g. ocean-themed gradient or character art), and completion progress (e.g. "3 of 20 stories completed")
   - Use `ProgressTracker` to calculate completion progress for the pack's stories
   - Tapping a pack card calls a callback/binding that tells ContentView to navigate to the grid
   - Layout: centered card(s) in a landscape-optimized arrangement, designed so additional packs can be added as cards alongside
   - Style: cream background (`#FFF8E7`), rounded card with shadow, brown text (`#5D4E37`), ocean blue accent for the pack theme
   - Include a header/title area ("Your Adventures" or similar)
   - Include difficulty badge showing current difficulty level (same style as grid's badge) — tapping it opens a parental gate -> difficulty picker flow
   - Include a "For Parents" lock icon button (same pattern as LabyrinthGridView) for parental gate -> privacy policy

2. **Modify `LowDopamineLabyrinth/LowDopamineLabyrinth/ContentView.swift`**:
   - Replace the binary `if/else` navigation with a three-state model
   - Add a `@State` property to track whether a pack has been selected (or use a more structured navigation approach)
   - Navigation flow:
     - `!hasCompletedOnboarding` -> `OnboardingView`
     - `hasCompletedOnboarding && no pack selected` -> `BookshelfView`
     - `hasCompletedOnboarding && pack selected` -> `LabyrinthGridView`
   - OnboardingView completion (sets `hasCompletedOnboarding = true`) now leads to BookshelfView, not directly to grid
   - BookshelfView passes pack selection back to ContentView, which then shows LabyrinthGridView
   - Consider: pack selection should NOT be persisted to UserDefaults (user returns to bookshelf on app relaunch). On every app launch after onboarding, the user sees the bookshelf first.
   - LabyrinthGridView should have a way to navigate back to the bookshelf (a back button or callback). Consider adding a "Back to Bookshelf" button or allowing the grid's existing navigation to support going back.

3. **Wire up EnvironmentObjects**: BookshelfView needs access to `UserPreferences`, `ProgressTracker`, and `SubscriptionManager` (same pattern as other views in the app — they are injected at the app level and accessed via `@EnvironmentObject`).


## Acceptance Criteria

- [ ] `BookshelfView.swift` exists at `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/BookshelfView.swift`
- [ ] BookshelfView shows at least one pack card with title and completion progress
- [ ] BookshelfView uses `LabyrinthLoader.shared.loadStories()` to get story data
- [ ] ContentView navigation has 3 states: onboarding, bookshelf, grid
- [ ] After onboarding completion, user sees BookshelfView (not grid directly)
- [ ] Tapping a pack card in BookshelfView navigates to LabyrinthGridView
- [ ] Pack selection is NOT persisted — app relaunch after onboarding shows bookshelf
- [ ] BookshelfView layout is landscape-optimized for iPad
- [ ] Visual style matches app aesthetic: cream background, brown text, rounded corners, gentle shadows
- [ ] LabyrinthGridView has a way to navigate back to the bookshelf
- [ ] `xcodebuild build` succeeds with no errors
- [ ] NOTE: BookshelfView.swift is NOT yet in pbxproj — that happens in task 11. Create the file but xcodebuild build will not include it until task 11.
- [ ] NOTE: `ParentalGateAction` is a private enum in `LabyrinthGridView` — if BookshelfView needs a parental gate flow, define a local equivalent or make the enum internal.

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md)
- [ux-guidelines.md](~/.claude/skills/project-knowledge/references/ux-guidelines.md)
- [ContentView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ContentView.swift)
- [OnboardingView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/OnboardingView.swift)
- [LabyrinthGridView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthGridView.swift)
- [LabyrinthLoader.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/LabyrinthLoader.swift)
- [UserPreferences.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/UserPreferences.swift)
- [Labyrinth.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/Labyrinth.swift)

## Verification Steps

1. Verify `BookshelfView.swift` exists at the expected path.
2. Verify ContentView.swift has three navigation states (not just a boolean toggle).
3. Run `xcodebuild build` — should succeed (assuming task 11 has added the file to pbxproj; if not, verify the file compiles in isolation by checking for syntax errors).
4. Grep for `BookshelfView` in ContentView.swift — should be referenced.
5. Grep for `loadStories` in BookshelfView.swift — should call LabyrinthLoader's story loading API.
6. Verify BookshelfView does NOT persist pack selection to UserDefaults.

## Details

**Files:**
- NEW `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/BookshelfView.swift` — the bookshelf/pack picker screen
- `LowDopamineLabyrinth/LowDopamineLabyrinth/ContentView.swift` — add intermediate bookshelf state to navigation

**Dependencies:**
- Task 4 (LabyrinthLoader `loadStories()` and `StoryInfo` model) must be complete before this task can fully compile
- Task 11 will add BookshelfView.swift to the pbxproj file

**Current ContentView navigation (before this task):**
```swift
struct ContentView: View {
    @EnvironmentObject var preferences: UserPreferences

    var body: some View {
        if preferences.hasCompletedOnboarding {
            LabyrinthGridView()
        } else {
            OnboardingView()
        }
    }
}
```

**After this task, ContentView navigation should be:**
```
if !hasCompletedOnboarding -> OnboardingView
else if no pack selected   -> BookshelfView(onPackSelected: ...)
else                       -> LabyrinthGridView (with back-to-bookshelf)
```

**Current OnboardingView completion action (relevant lines):**
```swift
preferences.difficultyLevel = level
preferences.hasCompletedOnboarding = true
```
This stays the same — OnboardingView sets `hasCompletedOnboarding = true`, and ContentView now routes to BookshelfView instead of grid.

**What BookshelfView needs to pass to LabyrinthGridView:**
- The pack's story list (or at minimum, the pack identifier so the grid knows which stories to show)
- LabyrinthGridView currently calls `gameViewModel.loadLabyrinths()` on appear, which uses `LabyrinthLoader.shared.loadForDifficulty()` — this existing behavior can remain; pack filtering can be layered on later when multiple packs exist

**Edge cases:**
- Single pack: the bookshelf should still show correctly with one centered card, not look empty or misaligned
- No stories loaded: if `loadStories()` returns empty (e.g. missing manifest), show a graceful empty state
- Back navigation from grid: must cleanly reset the pack selection state without re-triggering onboarding

**Implementation hints:**
- Use `@State private var selectedPack: String? = nil` in ContentView for the three-state navigation. `nil` means bookshelf, non-nil means grid for that pack.
- BookshelfView can accept an `onPackSelected: (String) -> Void` closure for pack tap action
- For the "back to bookshelf" from grid, pass a callback or binding that sets `selectedPack = nil`
- The pack card can use a gradient background similar to the difficulty cards in OnboardingView, but with ocean-themed colors (blues/teals)
- Completion progress: count completed stories (a story is complete when all 3 difficulty levels are done) using ProgressTracker. For now a simpler metric (completed labyrinths / total labyrinths in pack) is also acceptable.

## Reviewers

- **code-reviewer** -> `logs/working/task-8/code-reviewer-{round}.json`

## Post-completion

- [ ] Record brief report in decisions.md (Summary: 1-3 sentences, review with links to JSON, no finding tables or dumps)
- [ ] If deviated from spec -- describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
