---
status: planned
depends_on: [5]
wave: 3
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, security-auditor]
teammate_name:
---

# Task 7: PaywallView -- single product

## Required Skills

Before executing, load:
- `/skill:code-writing` -- [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Replace the current multi-plan subscription picker in PaywallView with a single-product purchase UI for the non-consumable pack IAP. The current PaywallView has a two-column landscape layout: left column with hero image and benefits, right column with multiple PlanCard radio-button cards, a dynamic CTA button ("Start Free Trial" / "Buy Once" / "Subscribe"), and a "Maybe Later" dismiss button.

After task 5, SubscriptionManager exposes a single product (`labyrinth_pack_ocean`) instead of 3 subscription products. PaywallView must be simplified to match: no plan selection needed, no subscription terminology, no auto-renewal disclaimers. The purchase flow becomes: tap "Buy" -> parental gate -> purchase single product.

The parental gate (ParentalGateView) is a separate file and must remain as the mandatory step before any purchase, per Apple Kids Category guidelines (1.3). The restore purchases button and legal links (Terms, Privacy) must also remain.

## What to do

1. **Remove the PlanCard struct** (lines 192-272): Delete the entire `private struct PlanCard: View` and its `monthlyEquivalent` helper. This struct rendered radio-button plan cards with "Best Value" badges and trial info -- none of which apply to a single non-consumable product.

2. **Remove subscription-related state and constants**:
   - Delete `@State private var selectedProductID` -- no plan selection needed.
   - Delete `private let yearlyID` and `private let lifetimeID` -- these subscription product constants are gone.
   - Delete the `ctaText` computed property -- it switched between "Start Free Trial" / "Buy Once" / "Subscribe" based on the selected plan.

3. **Remove the auto-renewal disclaimer**: Delete the "Subscriptions auto-renew until cancelled..." text block. Non-consumable IAPs have no auto-renewal.

4. **Remove the right-column plan cards section**: Delete the `ForEach(subscriptionManager.products, ...)` block that rendered PlanCards with radio selection tap gestures.

5. **Replace the right column with single-product purchase UI**:
   - Show the pack price from `subscriptionManager.products.first` (the single product).
   - Display "Buy once, play forever" messaging to communicate the one-time nature.
   - Show the product display name and display price prominently.
   - Keep a loading state for when the product hasn't loaded yet.

6. **Simplify the CTA button**: Replace `ctaText` with a static label like "Unlock All Adventures" or incorporate the price (e.g., "Unlock for {price}"). The button still triggers `showParentalGate = true`.

7. **Simplify `executePurchase()`**: Instead of looking up `selectedProductID` in the products array, just use `subscriptionManager.products.first`. There is only one product.

8. **Update analytics events**: Change `Paywall.planSelected` (remove -- no plan to select), update `Paywall.dismissed` to not include `selectedPlan` parameter, keep `Paywall.purchaseAttempted` and `Paywall.purchaseSucceeded` with productId.

9. **Keep unchanged**:
   - Left column hero image ("denny"), title, benefits list -- update wording if needed (benefits already say "100 mazes across 20 ocean stories" which is still accurate).
   - Parental gate flow: `showParentalGate` state, `.fullScreenCover` presenting `ParentalGateView` with `onSuccess`/`onCancel` callbacks.
   - Restore Purchases button, Terms link, Privacy link (same URLs).
   - `#if DEBUG` Skip (Dev) button.
   - "Maybe Later" dismiss button.
   - `.task { await subscriptionManager.loadProducts() }` on appear.


## Acceptance Criteria

- [ ] `PlanCard` struct is fully removed from PaywallView.swift
- [ ] No references to `selectedProductID`, `yearlyID`, `lifetimeID`, `ctaText` in PaywallView.swift
- [ ] No subscription terminology remains ("auto-renew", "trial", "subscribe", "subscription")
- [ ] Single product price is displayed (from `subscriptionManager.products.first`)
- [ ] "Buy once, play forever" or equivalent one-time purchase messaging is present
- [ ] CTA button triggers parental gate (showParentalGate = true) before purchase
- [ ] `executePurchase()` uses `subscriptionManager.products.first` (not selectedProductID lookup)
- [ ] Restore Purchases button is present and calls `subscriptionManager.restorePurchases()`
- [ ] Legal links remain: Terms (https://olgavorona.github.io/lowdop/terms) and Privacy (https://olgavorona.github.io/lowdop/privacy)
- [ ] `#if DEBUG` Skip (Dev) button is preserved
- [ ] "Maybe Later" dismiss button is preserved
- [ ] ParentalGateView fullScreenCover remains with onSuccess -> executePurchase, onCancel -> dismiss gate
- [ ] `xcodebuild build` succeeds

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md)
- [ux-guidelines.md](~/.claude/skills/project-knowledge/references/ux-guidelines.md)
- [PaywallView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/PaywallView.swift) -- the file being modified
- [SubscriptionManager.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/SubscriptionManager.swift) -- API surface (after task 5: single product `labyrinth_pack_ocean`)
- [ParentalGateView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/ParentalGateView.swift) -- separate file, unchanged, used via fullScreenCover

## Verification Steps

1. Run `xcodebuild build` -- expect BUILD SUCCEEDED.
2. Grep PaywallView.swift for `PlanCard` -- expect 0 matches.
3. Grep PaywallView.swift for `selectedProductID`, `yearlyID`, `lifetimeID`, `ctaText` -- expect 0 matches.
4. Grep PaywallView.swift for `auto-renew`, `trial`, `Subscribe` (case-sensitive) -- expect 0 matches.
5. Grep PaywallView.swift for `ParentalGateView` -- expect 1+ matches (gate must remain).
6. Grep PaywallView.swift for `restorePurchases` -- expect 1+ matches.
7. Grep PaywallView.swift for `olgavorona.github.io/lowdop` -- expect 2 matches (terms + privacy).

## Details

**Files:**
- `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/PaywallView.swift` -- remove PlanCard struct, subscription state/constants, auto-renewal text; replace right column with single-product UI; simplify executePurchase.

**Dependencies:**
- Task 5 (SubscriptionManager rewrite) must be completed first. After task 5, `subscriptionManager.products` contains a single `Product` for `labyrinth_pack_ocean` (non-consumable). The `purchase()`, `restorePurchases()`, `loadProducts()`, and `isPremium` API surface remains the same -- only the product type and count changed.

**Edge cases:**
- `subscriptionManager.products` may be empty while loading -- keep the "Loading..." fallback and disable the CTA button when products are empty.
- If the single product fails to load, the user can still dismiss via "Maybe Later" or restore purchases.
- The `onSkip` closure remains optional -- used by parent views to handle dev-mode skip.

**Implementation hints:**
- The two-column HStack layout can be kept but the right column becomes simpler: product name, price, one-time messaging, CTA button, skip, dismiss.
- Use `subscriptionManager.products.first` for both display and purchase -- no need for a selectedProductID.
- The benefits list in the left column is fine as-is. If desired, adjust wording to emphasize "one-time purchase" but the current benefits ("100 mazes across 20 ocean stories", "Calm, focused screen time", "Educational facts & narration") are still accurate.

**Security note (for security-auditor):**
- The parental gate MUST remain as a mandatory step before purchase. The flow is: tap CTA -> `showParentalGate = true` -> ParentalGateView presented as fullScreenCover -> onSuccess calls `executePurchase()` -> actual StoreKit purchase. This is a COPPA / Apple Kids Category requirement (guideline 1.3). Do NOT allow any code path that calls `purchase()` without going through the parental gate first.

## Reviewers

- **code-reviewer** -> `logs/working/task-7/code-reviewer-{round}.json`
- **security-auditor** -> `logs/working/task-7/security-auditor-{round}.json`

## Post-completion

- [ ] Record brief report in decisions.md (Summary: 1-3 sentences, review with links to JSON, no finding tables or dumps)
- [ ] If deviated from spec -- describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
