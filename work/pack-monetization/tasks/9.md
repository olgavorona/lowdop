---
status: planned
depends_on: [5, 6, 8]
wave: 4
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, test-reviewer]
teammate_name:
---

# Task 9: GameViewModel + LabyrinthGridView — pack-based locking

## Required Skills

Before starting, load:
- `/skill:code-writing` — [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Replace the old free-play gating system in GameViewModel and LabyrinthGridView with the new pack-based locking model. The old model tracked daily play limits (3 free + 1/day) and showed banners about remaining plays. The new model locks stories 4-20 behind a one-time pack purchase and unlocks stories 1-3 for free — no daily limits, no play counters.

**GameViewModel changes:**
- Remove `canProceed()` method (no longer needed — locking is story-based, not time-based)
- Remove `preferences.recordPlay()` call from `completeCurrentLabyrinth()` (free-play tracking is gone after task 2)
- Add story-complete detection: determine when the user has completed all 3 difficulty levels (easy/medium/hard) of the current story

**LabyrinthGridView changes:**
- Remove free-play banners entirely (the "X free labyrinths left!" and "See you tomorrow!" banners)
- Replace sequential unlock logic (`index == 0 || previous completed`) with pack-based locking: stories 1-3 are always unlocked, stories 4-20 are locked unless `isPremium`
- Tapping a locked story triggers parental gate then paywall (instead of being a no-op)
- Remove `canProceed()` check from tap handler

**DifficultyPickerSheet changes:**
- Update `levelColors` dictionary from 5 entries (beginner/easy/medium/hard/expert) to 3 entries (easy/medium/hard)
- The `ForEach(DifficultyLevel.allCases)` loop automatically picks up the 3-case enum from task 2

## What to do

### Step 1: Update GameViewModel

In `ViewModels/GameViewModel.swift`:

1. Remove the `canProceed()` method entirely
2. In `completeCurrentLabyrinth()`, remove the `preferences.recordPlay()` call — keep only `progressTracker.markCompleted(lab.id)`
3. Add a computed property `isStoryComplete` that checks whether all 3 difficulty levels of the current labyrinth's story are completed. Use the labyrinth ID pattern `denny_XXX_{easy,medium,hard}` to derive the story number and check all 3 variants against `progressTracker.completedIds`
4. Add a helper method `storyNumber(for labyrinth: Labyrinth) -> Int?` that extracts the story number from a labyrinth ID (e.g., `denny_005_easy` -> `5`)
5. Add a method `isStoryLocked(_ storyNumber: Int) -> Bool` that returns `true` if `storyNumber > 3 && !isPremium`

### Step 2: Update LabyrinthGridView grid and tap logic

In `Views/LabyrinthGridView.swift`:

1. Remove the entire free-play banner block (lines with `freeLabyrinthsRemaining`, `totalFreeLabyrinthsPlayed`, the gift banner, and the "See you tomorrow" banner)
2. Replace the sequential unlock logic in the grid. Currently `isUnlocked = index == 0 || progressTracker.isCompleted(...)`. Change to: extract the story number from the labyrinth, stories 1-3 are unlocked, stories 4-20 are unlocked only if `subscriptionManager.isPremium`
3. Update the tap handler: remove the `canProceed()` check. For unlocked stories, directly call `selectLabyrinth`. For locked stories, set `pendingLabyrinth` and trigger parental gate -> paywall flow
4. Remove the `paywallSkipped` state variable and related logic — locked stories should only unlock via purchase, not skip
5. Add a `ParentalGateAction.paywall` case to handle the locked-story -> parental gate -> paywall flow. **IMPORTANT:** Adding a new case to the `ParentalGateAction` enum requires updating the exhaustive `switch` in `onSuccess` to handle `.paywall` (e.g., `case .paywall: showPaywall = true`).
6. Update the `showPaywall` `onDismiss` closure — it currently references `paywallSkipped` which is being removed. Update to check only `isPremium` for post-paywall navigation.

### Step 3: Update DifficultyPickerSheet

In the `DifficultyPickerSheet` struct within `LabyrinthGridView.swift`:

1. Update `levelColors` dictionary to 3 entries:
   - `.easy`: blue gradient (use the existing `.beginner` colors)
   - `.medium`: medium blue gradient (keep existing `.medium` colors)
   - `.hard`: dark blue gradient (use the existing `.expert` colors)
2. Remove the `.beginner` and `.expert` entries
3. The `ForEach(DifficultyLevel.allCases)` loop needs no change — it iterates the enum which now has 3 cases (from task 2)

### Step 4: Clean up unused references

- Remove any remaining references to `canProceed`, `freeLabyrinthsRemaining`, `totalFreeLabyrinthsPlayed`, `dailyLabyrinthsPlayed`, `recordPlay` in both files
- Ensure `showPaywall` state and paywall sheet presentation still work for the locked-story flow

## TDD Anchor

Write tests BEFORE implementing the changes. Add to `GameViewModelTests.swift`:

- `testStoryNumberExtraction` — verify `storyNumber(for:)` returns correct Int for IDs like `denny_001_easy` (1), `denny_015_hard` (15), `denny_020_medium` (20)
- `testIsStoryLockedFreeUser` — stories 1-3 return `false` (unlocked), stories 4-20 return `true` (locked) when `isPremium = false`
- `testIsStoryLockedPremiumUser` — all stories 1-20 return `false` (unlocked) when `isPremium = true`
- `testIsStoryLockedAfterPurchase` — story starts locked (`isPremium = false`), then unlocks after setting `isPremium = true`
- `testIsStoryCompleteAllDifficulties` — mark `denny_005_easy`, `denny_005_medium`, `denny_005_hard` as completed in ProgressTracker, verify `isStoryComplete` returns `true` when current labyrinth is from story 5
- `testIsStoryCompletePartialDifficulties` — mark only `denny_005_easy` and `denny_005_medium` as completed, verify `isStoryComplete` returns `false`
- `testCompleteCurrentLabyrinthDoesNotCallRecordPlay` — verify that completing a labyrinth only calls `progressTracker.markCompleted` and does NOT modify `preferences.dailyLabyrinthsPlayed` or `preferences.totalFreeLabyrinthsPlayed`

Remove or rewrite the old free-play tests (they test `canProceed`, `recordPlay`, daily limits — all removed):
- Remove `testCanProceedReturnsTrueForPremiumUser`
- Remove `testCanProceedReturnsTrueWhenNoPlaysRecorded`
- Remove `testCanProceedReturnsFalseAfterDailyLimitReached`
- Remove `testCanProceedResetsOnNewDay`
- Remove `testCompleteLabyrinthRecordsPlay`
- Remove `testPaywallFlowFreeUserBlockedAfterFourthCompletion`
- Remove `testPaywallFlowPremiumUserCanAlwaysAdvance`
- Remove `testPaywallFlowPurchaseMidSessionUnblocks`
- Remove `testMaybeLaterClosesGameForFreeUser`
- Remove `testFreeUserCannotStartLabyrinthAfterDailyLimit`
- Remove `testFreeUserGetsThreeFreePlaysBeforeLimit`
- Remove `testFreeUserAfterThreeFreePlaysGetsOnePerDay`
- Remove `testTotalFreeCounterIncrementsOnRecordPlay`
- Remove `testFreeLabyrinthsRemainingDuringInitialFree`
- Remove `testFreeLabyrinthsRemainingReturnsNilForPremium`
- Remove `testRecordPlayResetsCountOnNewDay`
- Remove `testRecordPlayIncrementsOnSameDay`

## Acceptance Criteria

- [ ] `canProceed()` method removed from GameViewModel
- [ ] `preferences.recordPlay()` call removed from `completeCurrentLabyrinth()`
- [ ] `isStoryComplete` computed property works correctly (checks all 3 difficulty levels)
- [ ] `storyNumber(for:)` correctly extracts story number from labyrinth ID
- [ ] `isStoryLocked(_:)` returns correct values: stories 1-3 free, 4-20 locked unless premium
- [ ] Free-play banners completely removed from LabyrinthGridView (no "X free labyrinths left", no "See you tomorrow")
- [ ] Grid locking is pack-based: stories 1-3 show characters, stories 4-20 show lock icons (unless premium)
- [ ] Tapping a locked story triggers parental gate then paywall
- [ ] Tapping an unlocked story directly starts the game (no `canProceed` check)
- [ ] DifficultyPickerSheet shows 3 levels (easy/medium/hard) with correct color gradients
- [ ] No references to `canProceed`, `freeLabyrinthsRemaining`, `totalFreeLabyrinthsPlayed`, `recordPlay` remain in either file
- [ ] All new TDD tests pass
- [ ] All old free-play tests removed
- [ ] Build succeeds: `xcodebuild build` passes
- [ ] Tests pass: `xcodebuild test` passes

## Context Files

- [user-spec.md](../user-spec.md) — acceptance criteria: stories 1-3 free, 4-20 locked, pack purchase unlocks all
- [tech-spec.md](../tech-spec.md) — task 9 description, data models, architecture overview
- [decisions.md](../decisions.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md) — project overview
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md) — MVVM structure, navigation patterns
- [patterns.md](~/.claude/skills/project-knowledge/references/patterns.md) — conventions, testing patterns
- [GameViewModel.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift) — main file to modify (remove free-play gating, add story detection)
- [LabyrinthGridView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthGridView.swift) — main file to modify (pack-based locking, remove banners)
- [SubscriptionManager.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/SubscriptionManager.swift) — `isPremium` property (after task 5: single non-consumable)
- [LabyrinthLoader.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/LabyrinthLoader.swift) — story data loading (after task 4)
- [UserPreferences.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/UserPreferences.swift) — DifficultyLevel enum with 3 cases (after task 2)
- [ProgressTracker.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/ProgressTracker.swift) — `completedIds`, `isCompleted`, `markCompleted`
- [GameViewModelTests.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift) — tests to rewrite

## Verification Steps

1. **Build succeeds:**
   ```bash
   xcodebuild build -project LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj -scheme LowDopamineLabyrinth -destination 'platform=iOS Simulator,id=D1CE5302-B5A3-4999-B0FE-FE96E86BA3F1'
   # Expected: BUILD SUCCEEDED
   ```

2. **Tests pass:**
   ```bash
   xcodebuild test -project LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj -scheme LowDopamineLabyrinth -destination 'platform=iOS Simulator,id=D1CE5302-B5A3-4999-B0FE-FE96E86BA3F1' -only-testing:LowDopamineLabyrinthTests
   # Expected: TEST SUCCEEDED
   ```

3. **No references to removed APIs in modified files:**
   ```bash
   grep -n 'canProceed\|freeLabyrinthsRemaining\|totalFreeLabyrinthsPlayed\|recordPlay\|dailyLabyrinthsPlayed' LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthGridView.swift
   # Expected: no output (0 matches)
   ```

4. **No beginner/expert in DifficultyPickerSheet:**
   ```bash
   grep -n 'beginner\|expert' LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthGridView.swift
   # Expected: no output (0 matches)
   ```

5. **Story locking tests exist:**
   ```bash
   grep -c 'testIsStoryLocked\|testStoryNumber\|testIsStoryComplete' LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift
   # Expected: 7 (matching the 7 new test methods)
   ```

6. **Old free-play tests removed:**
   ```bash
   grep -c 'canProceed\|testFreeUser\|testRecordPlay\|testPaywallFlow.*Blocked\|testPaywallFlow.*Advance\|testPaywallFlow.*Purchase\|testMaybeLater\|testFreeLabyrinthsRemaining\|testTotalFreeCounter\|testCompleteLabyrinthRecordsPlay' LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift
   # Expected: 0 (all old free-play tests removed)
   ```

## Details

**Files to modify:**
- `LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift` — remove `canProceed()`, remove `recordPlay()` call, add `isStoryComplete`, `storyNumber(for:)`, `isStoryLocked(_:)`
- `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthGridView.swift` — remove free-play banners, replace sequential unlock with pack-based locking, update tap handler, update DifficultyPickerSheet colors
- `LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift` — remove 17 old free-play tests, add 7 new pack-locking tests

**Dependencies on prior tasks:**
- Task 2 (DifficultyLevel enum reduced to 3 cases) — DifficultyPickerSheet iterates `DifficultyLevel.allCases` which must be `[.easy, .medium, .hard]`
- Task 5 (SubscriptionManager single non-consumable) — `isPremium` flag drives lock state
- Task 6 (OnboardingView 3 cards) — ensures onboarding sets a valid 3-case difficulty
- Task 8 (BookshelfView + ContentView navigation) — navigation flow includes bookshelf between onboarding and grid

**Story number extraction pattern:**
Labyrinth IDs follow the format `denny_XXX_difficulty` where XXX is a zero-padded 3-digit story number. Extract by splitting on `_` and parsing the second component as Int. Example: `denny_005_easy` -> split -> `["denny", "005", "easy"]` -> `Int("005")` -> `5`.

**Story-complete detection logic:**
For a given story number N, the 3 labyrinth IDs are `denny_NNN_easy`, `denny_NNN_medium`, `denny_NNN_hard` (NNN = zero-padded). Check all 3 against `progressTracker.completedIds`. All 3 must be completed for the story to be "complete".

**Lock state logic:**
- Stories 1-3 (`storyNumber <= 3`): always unlocked, free to play
- Stories 4-20 (`storyNumber > 3`): locked unless `subscriptionManager.isPremium == true`
- Within an unlocked story, all difficulty levels are accessible (no sequential difficulty unlock)

**Edge cases:**
- Labyrinth ID that doesn't match the `denny_XXX_difficulty` pattern: `storyNumber(for:)` should return `nil`, treat as unlocked to avoid blocking
- `isStoryComplete` when labyrinth list is empty or current labyrinth is nil: return `false`
- Premium user who hasn't completed any mazes: all stories show unlocked, no lock icons anywhere
- Free user tapping story 4+: should go through parental gate THEN paywall (same parental gate mechanism already in LabyrinthGridView)

**Implementation hints:**
- The `ParentalGateAction` enum already exists — add a `.paywall` case for the locked-story flow
- The paywall sheet presentation (`showPaywall`) and `pendingLabyrinth` pattern already exist — reuse for the locked-story -> paywall flow
- `DifficultyPickerSheet` already uses `ForEach(DifficultyLevel.allCases)` — just update the `levelColors` dictionary to have 3 entries matching the new enum cases
- In the grid, derive story number from labyrinth ID to determine lock state, rather than using the grid index (story number is content-based, not position-based)

## Reviewers

- **code-reviewer** -> `logs/working/task-9/code-reviewer-1.json`
- **test-reviewer** -> `logs/working/task-9/test-reviewer-1.json`

## Post-completion

- [ ] Record brief summary in decisions.md (Summary: 1-3 sentences, review with links to JSON, no findings tables or dumps)
- [ ] If deviated from spec — describe the deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
