---
status: planned
depends_on: [9, 10]
wave: 4
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, test-reviewer]
teammate_name:
---

# Task 11: Tests + pbxproj cleanup

## Required Skills

Before executing this task, load:
- `/skill:code-writing` — [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Rewrite the free-play tests in `GameViewModelTests.swift` to test the new pack-based locking model, add new test coverage for `StoryInfo`, `DifficultyLevel` (3 cases), and `LabyrinthLoader` story-loading APIs. Then update `project.pbxproj` to reflect all file changes from the feature: remove 40 deleted lv2/lv4 JSON file references, rename 60 lv1/lv3/lv5 references to easy/medium/hard, and add `BookshelfView.swift`.

This is the dedicated test task for the pack-monetization feature. By the time this task runs, tasks 1-10 have already modified the production code. This task ensures test coverage catches up and the Xcode project file is consistent with the actual file system.

## What to do

### Part 1: Rewrite and add tests in GameViewModelTests.swift

1. **Remove all free-play tests.** Delete every test that references `canProceed()`, `recordPlay()`, `canPlayToday()`, `dailyLabyrinthsPlayed`, `totalFreeLabyrinthsPlayed`, `freeLabyrinthsRemaining`, `lastPlayedTimestamp`. These are the tests in the "Paywall / canProceed Tests" and "3-Free Model Tests" MARK sections, plus `testCompleteLabyrinthRecordsPlay`, `testRecordPlayResetsCountOnNewDay`, `testRecordPlayIncrementsOnSameDay`, `testFreeUserCannotStartLabyrinthAfterDailyLimit`, `testMaybeLaterClosesGameForFreeUser`.

2. **Update the `tearDown()` method.** Remove cleanup of deleted UserDefaults keys (`lastPlayedTimestamp`, `dailyLabyrinthsPlayed`, `totalFreeLabyrinthsPlayed`). Keep cleanup of keys that still exist (`difficultyLevel`, `ttsEnabled`, `hasCompletedOnboarding`, `ttsDefaultSet`, `completedLabyrinths`).

3. **Update `makeSampleLabyrinths` helper.** Remove the `ageRange` parameter (set to nil or remove entirely, matching the post-task-4 Labyrinth model which no longer has `ageRange`). Ensure `difficulty` uses the new valid values ("easy", "medium", "hard").

4. **Keep all existing navigation tests unchanged** (they don't reference free-play logic): `testNextLabyrinthIncrementsIndex`, `testNextLabyrinthDoesNotExceedBounds`, `testPreviousLabyrinthDecrementsIndex`, `testPreviousLabyrinthDoesNotGoBelowZero`, `testSelectLabyrinthSetsIndexAndPlaying`, `testCloseGameStopsPlaying`, `testNextLabyrinthDoesNotDismissFullScreenCover`, `testPreviousLabyrinthDoesNotDismissFullScreenCover`, `testCurrentLabyrinthReflectsIndex`, `testCompleteCurrentLabyrinthTracksProgress`, `testNavigationSequenceCompletionThenNext`, `testSelectLabyrinthDoesNotSetPlayingWhenNotFound`. Update any of these that set `sub.isPremium = true` purely for canProceed bypass (now unnecessary since canProceed is removed).

5. **Add new pack-based locking tests** in a new MARK section "Pack-Based Locking Tests":
   - Test that stories 1-3 (indices 0-2) are always accessible regardless of purchase state
   - Test that stories 4-20 (indices 3-19) are locked when `isPremium == false`
   - Test that stories 4-20 unlock when `isPremium == true`
   - Test that purchasing mid-session (setting `isPremium = true`) unlocks all stories
   - Test that the `isPremium` property on GameViewModel correctly reflects SubscriptionManager state

6. **Add DifficultyLevel tests** in a new test class or MARK section:
   - Test that `DifficultyLevel.allCases` has exactly 3 cases
   - Test that the 3 cases are `.easy`, `.medium`, `.hard`
   - Test `pathTolerance` values: easy=25, medium=18, hard=12
   - Test `displayName`: "Easy", "Medium", "Hard"
   - Test `Codable` round-trip for each case

7. **Add StoryInfo tests** in a new test class or MARK section:
   - Test StoryInfo initialization with all fields
   - Test `isFree` is true for stories 1-3 and false for stories 4-20
   - Test `isAdventure` is true for stories 11-20 and false for stories 1-10
   - Test `id` returns the `number` value
   - Test `labyrinthIds` contains the expected IDs for a story

8. **Add LabyrinthLoader story-loading tests** in a new test class or MARK section:
   - Test `loadStories()` returns story metadata (if testable without bundle resources, use a mock or verify the function signature exists)
   - Test `loadForStory()` filters labyrinths correctly by story number
   - Test that loaded labyrinths have correct difficulty values (only "easy", "medium", "hard")

### Part 2: Update project.pbxproj

9. **Remove 40 deleted file references.** For each of the 20 stories (001-020), remove the lv2 and lv4 entries from all pbxproj sections:
   - `PBXBuildFile` section: remove lines with `AA20XX02` and `AA20XX04` (where XX = 01-20)
   - `PBXFileReference` section: remove lines with `AC20XX02` and `AC20XX04`
   - `PBXResourcesBuildPhase` files list: remove references to `AA20XX02` and `AA20XX04`
   - Labyrinths group children: remove references to `AC20XX02` and `AC20XX04`

10. **Rename 60 file references.** Update the comment names (not the hex IDs themselves) in all pbxproj sections:
    - `_lv1.json` -> `_easy.json` (IDs ending in 01)
    - `_lv3.json` -> `_medium.json` (IDs ending in 03)
    - `_lv5.json` -> `_hard.json` (IDs ending in 05)
    - Update in PBXBuildFile comments, PBXFileReference comments and `path` values, group children comments, and resource build phase comments

11. **Add BookshelfView.swift.** Use the next available sequential IDs:
    - `AA000029` for PBXBuildFile (BookshelfView.swift in Sources)
    - `AB000029` for PBXFileReference (BookshelfView.swift)
    - Add `AB000029` to the Views group children list
    - Add `AA000029` to the PBXSourcesBuildPhase files list

## TDD Anchor

This IS the test task. All tests below should be written and verified to pass.

Test file: `LowDopamineLabyrinthTests/GameViewModelTests.swift`

### Pack-based locking tests (replace free-play tests):
- `testIsPremiumReflectsSubscriptionManager` — `isPremium` mirrors `subscriptionManager.isPremium` (keep existing, unchanged)
- `testStoryIsAccessibleWhenFree` — stories at indices 0-2 (stories 1-3) are accessible without purchase
- `testStoryIsLockedWhenNotPurchased` — stories at indices 3+ are locked when `isPremium == false`
- `testStoryUnlocksAfterPurchase` — stories at indices 3+ become accessible when `isPremium == true`
- `testPurchaseMidSessionUnlocksAllStories` — setting `isPremium = true` after selection unlocks everything
- `testCloseGameReturnsToGrid` — closing game sets `isPlaying = false` (keep existing `testCloseGameStopsPlaying`)

### DifficultyLevel tests (new):
- `testDifficultyLevelHasExactlyThreeCases` — `DifficultyLevel.allCases.count == 3`
- `testDifficultyLevelCases` — cases are `.easy`, `.medium`, `.hard` in that order
- `testDifficultyLevelPathTolerance` — `.easy.pathTolerance == 25`, `.medium.pathTolerance == 18`, `.hard.pathTolerance == 12`
- `testDifficultyLevelDisplayName` — `.easy.displayName == "Easy"`, `.medium.displayName == "Medium"`, `.hard.displayName == "Hard"`
- `testDifficultyLevelCodableRoundTrip` — encode then decode each case, verify identity

### StoryInfo tests (new):
- `testStoryInfoInitialization` — create StoryInfo, verify all fields
- `testStoryInfoIdEqualsNumber` — `StoryInfo(number: 5, ...).id == 5`
- `testStoryInfoIsFreeForFirstThreeStories` — stories 1-3 have `isFree == true`
- `testStoryInfoIsNotFreeForLaterStories` — stories 4-20 have `isFree == false`
- `testStoryInfoIsAdventureForStoriesElevenToTwenty` — stories 11-20 have `isAdventure == true`
- `testStoryInfoIsNotAdventureForStoriesOneToTen` — stories 1-10 have `isAdventure == false`

### LabyrinthLoader tests (new):
- `testLoadStoriesReturnsStoryMetadata` — `loadStories()` returns non-empty array of StoryInfo
- `testLoadForStoryFiltersByStoryNumber` — `loadForStory(1)` returns only labyrinths for story 1
- `testLoadedLabyrinthsHaveValidDifficulty` — all loaded labyrinths have difficulty in ["easy", "medium", "hard"]

## Acceptance Criteria

- [ ] All free-play tests removed (no references to `canProceed`, `recordPlay`, `canPlayToday`, `dailyLabyrinthsPlayed`, `totalFreeLabyrinthsPlayed`, `freeLabyrinthsRemaining`, `lastPlayedTimestamp` in test file)
- [ ] Navigation tests preserved and passing
- [ ] Pack-based locking tests added and passing
- [ ] DifficultyLevel tests added and passing (3 cases, correct pathTolerance, Codable)
- [ ] StoryInfo tests added and passing (isFree, isAdventure, id)
- [ ] LabyrinthLoader story-loading tests added and passing
- [ ] LabyrinthViewModelItemTests preserved and passing (no changes needed)
- [ ] pbxproj: 40 lv2/lv4 file references removed (no `_lv2.json` or `_lv4.json` in pbxproj)
- [ ] pbxproj: 60 file references renamed (all labyrinth refs use `_easy.json`, `_medium.json`, `_hard.json`)
- [ ] pbxproj: BookshelfView.swift added with correct IDs (AA000029, AB000029)
- [ ] `xcodebuild test` succeeds — all tests pass
- [ ] No references to old difficulty names ("beginner", "expert") in test file

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](~/.claude/skills/project-knowledge/references/patterns.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md)
- [GameViewModelTests.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift) — the test file to rewrite
- [GameViewModel.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift) — post-task-9 API (pack-based, no canProceed/recordPlay)
- [LabyrinthLoader.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/LabyrinthLoader.swift) — post-task-4 API (loadStories, loadForStory)
- [UserPreferences.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/UserPreferences.swift) — post-task-2 (3-case DifficultyLevel, no free-play tracking)
- [Labyrinth.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/Labyrinth.swift) — post-task-4 (StoryInfo model, storyNumber/levelName on Labyrinth)
- [project.pbxproj](../../../LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj) — Xcode project file to update

## Verification Steps

- Step 1: Run `xcodebuild test` — all tests must pass:
  ```bash
  xcodebuild test -project LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj -scheme LowDopamineLabyrinth -destination 'platform=iOS Simulator,id=D1CE5302-B5A3-4999-B0FE-FE96E86BA3F1' -only-testing:LowDopamineLabyrinthTests
  ```
- Step 2: Verify no free-play references remain in test file:
  ```bash
  grep -E 'canProceed|recordPlay|canPlayToday|dailyLabyrinthsPlayed|totalFreeLabyrinthsPlayed|freeLabyrinthsRemaining|lastPlayedTimestamp' LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift
  # Expected: no output (exit code 1)
  ```
- Step 3: Verify pbxproj has no lv2/lv4 references:
  ```bash
  grep -c '_lv[24]\.json' LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj
  # Expected: 0
  ```
- Step 4: Verify pbxproj has no lv1/lv3/lv5 references:
  ```bash
  grep -c '_lv[135]\.json' LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj
  # Expected: 0
  ```
- Step 5: Verify BookshelfView.swift is in pbxproj:
  ```bash
  grep -c 'BookshelfView.swift' LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj
  # Expected: 3 or more (PBXBuildFile, PBXFileReference, group, sources phase)
  ```
- Step 6: Verify the total labyrinth reference count is 60 (not 100):
  ```bash
  grep -c 'denny_.*\.json' LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj
  # Expected: ~240 (60 files x 4 references each: BuildFile, FileRef, group child, resource phase)
  ```

## Details

**Files to modify:**
- `LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift` — rewrite tests
- `LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj` — file reference cleanup

**Dependencies on prior tasks:**
- Task 1: Content files renamed/deleted (need pbxproj to match)
- Task 2: DifficultyLevel reduced to 3 cases (tests verify this)
- Task 4: StoryInfo model and LabyrinthLoader story APIs added (tests cover these)
- Task 8: BookshelfView.swift created (needs pbxproj entry)
- Task 9: GameViewModel free-play logic removed, pack-based locking added (tests verify new API)
- Task 10: Story-complete flow updated (tests may touch this)

**pbxproj ID scheme (from MEMORY.md):**
- `AA` prefix = PBXBuildFile
- `AB` prefix = PBXFileReference
- `AC` prefix = Resource file references (labyrinth JSONs)
- `AE` prefix = PBXGroup
- Labyrinth IDs: `AA20XXYY` / `AC20XXYY` where XX=story(01-20), YY=level(01-05)
- Levels to delete: YY=02 (lv2) and YY=04 (lv4) — 40 entries per section
- Levels to rename: YY=01 (lv1->easy), YY=03 (lv3->medium), YY=05 (lv5->hard)
- BookshelfView: AA000029 (BuildFile), AB000029 (FileReference) — next after Analytics.swift (AA000027/AB000027). Note AA000028 is TelemetryDeck framework, not a source file.

**Edge cases:**
- Some navigation tests set `sub.isPremium = true` only to bypass the old `canProceed()` check in `nextLabyrinth()`. After task 9 removes that check, these are harmless but should be reviewed for clarity.
- The `makeSampleLabyrinths` helper must match the post-task-4 Labyrinth init (no `ageRange` parameter if it was removed, or `ageRange: nil` if the field still exists as optional).
- LabyrinthLoader tests that call `loadStories()` / `loadForStory()` depend on bundle resources. In the test target, these may return empty arrays. Consider testing with mock data or testing only the filtering logic.
- `testSelectLabyrinthDoesNotSetPlayingWhenNotFound` creates a fake Labyrinth — ensure its init matches the updated model.

**Tests to DELETE (all reference removed free-play APIs):**
1. `testCanProceedReturnsTrueForPremiumUser`
2. `testCanProceedReturnsTrueWhenNoPlaysRecorded`
3. `testCanProceedReturnsFalseAfterDailyLimitReached`
4. `testCanProceedResetsOnNewDay`
5. `testCompleteLabyrinthRecordsPlay`
6. `testPaywallFlowFreeUserBlockedAfterFourthCompletion`
7. `testPaywallFlowPremiumUserCanAlwaysAdvance`
8. `testPaywallFlowPurchaseMidSessionUnblocks`
9. `testMaybeLaterClosesGameForFreeUser`
10. `testFreeUserCannotStartLabyrinthAfterDailyLimit`
11. `testFreeUserGetsThreeFreePlaysBeforeLimit`
12. `testFreeUserAfterThreeFreePlaysGetsOnePerDay`
13. `testTotalFreeCounterIncrementsOnRecordPlay`
14. `testFreeLabyrinthsRemainingDuringInitialFree`
15. `testFreeLabyrinthsRemainingReturnsNilForPremium`
16. `testRecordPlayResetsCountOnNewDay`
17. `testRecordPlayIncrementsOnSameDay`

**Tests to KEEP (navigation, progress, items — no free-play references):**
1. `testNextLabyrinthIncrementsIndex`
2. `testNextLabyrinthDoesNotExceedBounds`
3. `testPreviousLabyrinthDecrementsIndex`
4. `testPreviousLabyrinthDoesNotGoBelowZero`
5. `testSelectLabyrinthSetsIndexAndPlaying`
6. `testCloseGameStopsPlaying`
7. `testNextLabyrinthDoesNotDismissFullScreenCover`
8. `testPreviousLabyrinthDoesNotDismissFullScreenCover`
9. `testCurrentLabyrinthReflectsIndex`
10. `testCompleteCurrentLabyrinthTracksProgress`
11. `testNavigationSequenceCompletionThenNext`
12. `testIsPremiumReflectsSubscriptionManager`
13. `testSelectLabyrinthDoesNotSetPlayingWhenNotFound`
14. `testSequentialUnlockLogic`
15. `testCompletedCountReflectsProgress`
16. All `LabyrinthViewModelItemTests` (entire class unchanged)

## Reviewers

- **code-reviewer** -> `logs/working/task-11/code-reviewer-{round}.json`
- **test-reviewer** -> `logs/working/task-11/test-reviewer-{round}.json`

## Post-completion

- [ ] Record brief summary in decisions.md (Summary: 1-3 sentences, review with links to JSON, no findings tables or dumps)
- [ ] If deviated from spec — describe the deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
