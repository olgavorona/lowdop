---
status: planned
depends_on: []
wave: 1
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, test-reviewer]
teammate_name:
---

# Task 2: DifficultyLevel enum and UserPreferences

## Required Skills

Before executing this task, load:
- `/skill:code-writing` — [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Reduce the `DifficultyLevel` enum from 5 cases (beginner/easy/medium/hard/expert) to 3 cases (easy/medium/hard), update `pathTolerance` values, and remove all free-play tracking logic from `UserPreferences`. This is one of the foundational changes for the pack monetization model: the free-play gating (3 total + 1/day) is being replaced by content-based locking (stories 1-3 free, rest require pack purchase), and the 5-level difficulty system is being simplified to 3 levels.

This task intentionally introduces compile errors in callers that reference removed properties/methods. Those callers are fixed in later tasks (Task 9: GameViewModel + LabyrinthGridView, Task 10: LabyrinthListView). The goal here is to make UserPreferences.swift correct and complete on its own.

## What to do

1. **Reduce `DifficultyLevel` enum from 5 to 3 cases.** Remove `beginner` and `expert`. Keep `easy`, `medium`, `hard`. Add `Codable` conformance. Update `pathTolerance` to the new values (easy=25, medium=18, hard=12). Keep the existing `displayName` computed property.

2. **Add graceful fallback for old UserDefaults values.** In `init()`, when loading the saved difficulty string, handle unknown rawValues (e.g., "beginner" or "expert" saved by a previous version) by defaulting to `.easy`. The current code already uses `?? .beginner` — change this to `?? .easy`.

3. **Remove all free-play tracking properties:**
   - `lastPlayedTimestamp: Date?` (lines 18-21)
   - `dailyLabyrinthsPlayed: Int` (lines 23-26)
   - `totalFreeLabyrinthsPlayed: Int` (lines 28-31)

4. **Remove all free-play tracking methods:**
   - `canPlayToday(isPremium:)` (lines 50-62)
   - `recordPlay()` (lines 64-78)
   - `freeLabyrinthsRemaining(isPremium:)` (lines 81-91)

5. **Keep the following properties/methods unchanged:**
   - `difficultyLevel: DifficultyLevel` (Published, with UserDefaults persistence)
   - `ttsEnabled: Bool` (Published, with UserDefaults persistence)
   - `hasCompletedOnboarding: Bool` (Published, with UserDefaults persistence)
   - `pathTolerance: CGFloat` (computed from difficultyLevel)
   - `init()` (with updated fallback logic)
   - The TTS default-setting logic in init

## TDD Anchor

Write these tests BEFORE implementing changes. Run them, confirm they fail, then implement.

Test file: `LowDopamineLabyrinthTests/UserPreferencesTests.swift` (new file, or add to existing GameViewModelTests.swift)

- `testDifficultyLevelHasExactlyThreeCases` — `DifficultyLevel.allCases.count == 3`, cases are `.easy`, `.medium`, `.hard`
- `testPathToleranceValues` — `.easy.pathTolerance == 25`, `.medium.pathTolerance == 18`, `.hard.pathTolerance == 12`
- `testDifficultyLevelDisplayName` — `.easy.displayName == "Easy"`, `.medium.displayName == "Medium"`, `.hard.displayName == "Hard"`
- `testDifficultyLevelCodable` — encode and decode each case, verify round-trip
- `testFallbackForUnknownDifficultyRawValue` — set UserDefaults "difficultyLevel" to "beginner", create UserPreferences, verify `difficultyLevel == .easy`
- `testFallbackForExpertDifficultyRawValue` — set UserDefaults "difficultyLevel" to "expert", create UserPreferences, verify `difficultyLevel == .easy`
- `testValidDifficultyRawValueLoadsCorrectly` — set UserDefaults "difficultyLevel" to "hard", create UserPreferences, verify `difficultyLevel == .hard`

## Acceptance Criteria

- [ ] `DifficultyLevel` has exactly 3 cases: `easy`, `medium`, `hard`
- [ ] No references to `beginner` or `expert` in `UserPreferences.swift`
- [ ] `DifficultyLevel` conforms to `Codable` (in addition to existing `String`, `CaseIterable`)
- [ ] `pathTolerance` values: easy=25, medium=18, hard=12
- [ ] Old UserDefaults values ("beginner", "expert") gracefully fall back to `.easy`
- [ ] Properties removed: `lastPlayedTimestamp`, `dailyLabyrinthsPlayed`, `totalFreeLabyrinthsPlayed`
- [ ] Methods removed: `canPlayToday(isPremium:)`, `recordPlay()`, `freeLabyrinthsRemaining(isPremium:)`
- [ ] `pathTolerance` computed property still works (delegates to `difficultyLevel.pathTolerance`)
- [ ] `ttsEnabled`, `hasCompletedOnboarding`, `init()` remain functional
- [ ] All TDD anchor tests pass
- [ ] `xcodebuild build` succeeds for UserPreferences.swift itself (callers may have errors — that is expected)

## Context Files

- [user-spec.md](../user-spec.md)
- [tech-spec.md](../tech-spec.md)
- [decisions.md](../decisions.md)
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](~/.claude/skills/project-knowledge/references/patterns.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md)
- [UserPreferences.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/UserPreferences.swift) — the file to modify
- [GameViewModel.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift) — calls `recordPlay()`, `canPlayToday()`, `canProceed()`
- [OnboardingView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/OnboardingView.swift) — references `DifficultyLevel.allCases`, `.beginner`, `.expert`
- [LabyrinthGridView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthGridView.swift) — calls `freeLabyrinthsRemaining()`, `totalFreeLabyrinthsPlayed`, `canProceed()`
- [LabyrinthListView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthListView.swift) — calls `canProceed()`
- [GameViewModelTests.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinthTests/GameViewModelTests.swift) — existing tests that reference free-play logic

## Verification Steps

- Step 1: Run `xcodebuild build` — the file itself should compile. Expect compile errors ONLY in callers (GameViewModel.swift, LabyrinthGridView.swift, LabyrinthListView.swift, OnboardingView.swift, GameViewModelTests.swift) that reference removed properties/methods or removed enum cases. UserPreferences.swift itself must have zero errors.
- Step 2: Verify with grep that no references to `beginner`, `expert`, `canPlayToday`, `recordPlay`, `freeLabyrinthsRemaining`, `totalFreeLabyrinthsPlayed`, `dailyLabyrinthsPlayed`, or `lastPlayedTimestamp` remain in UserPreferences.swift.
- Step 3: Run the TDD anchor tests in isolation (they should all pass).

## Details

**Files to modify:** `LowDopamineLabyrinth/LowDopamineLabyrinth/Models/UserPreferences.swift`

**Expected compile errors in other files (fixed by later tasks):**

| File | Broken reference | Fixed in task |
|------|-----------------|---------------|
| `GameViewModel.swift` | `preferences.recordPlay()` (line 62) | Task 9 |
| `GameViewModel.swift` | `canProceed()` calls `canPlayToday()` (line 67) | Task 9 |
| `LabyrinthGridView.swift` | `preferences.freeLabyrinthsRemaining(...)` (line 98) | Task 9 |
| `LabyrinthGridView.swift` | `preferences.totalFreeLabyrinthsPlayed` (line 99) | Task 9 |
| `LabyrinthGridView.swift` | `gameViewModel.canProceed()` (line 172) | Task 9 |
| `LabyrinthListView.swift` | `gameViewModel.canProceed()` (line 113) | Task 10 |
| `OnboardingView.swift` | `.beginner` and `.expert` in `levelColors` dict (lines 8-13) | Task 6 |
| `LabyrinthGridView.swift` | `.beginner` and `.expert` in `DifficultyPickerSheet.levelColors` (lines 338-343) | Task 9 |
| `GameViewModelTests.swift` | Multiple free-play test methods | Task 11 |

**Target enum shape:**
```swift
enum DifficultyLevel: String, CaseIterable, Codable {
    case easy, medium, hard

    var displayName: String { rawValue.capitalized }

    var pathTolerance: CGFloat {
        switch self {
        case .easy: return 25
        case .medium: return 18
        case .hard: return 12
        }
    }
}
```

**Fallback logic in init:**
```swift
let savedLevel = defaults.string(forKey: "difficultyLevel") ?? DifficultyLevel.easy.rawValue
self.difficultyLevel = DifficultyLevel(rawValue: savedLevel) ?? .easy
```
This handles: (a) no saved value → "easy" string → `.easy`, (b) saved "beginner"/"expert" → rawValue init returns nil → `.easy`, (c) saved "hard" → `.hard`.

**Edge cases:**
- UserDefaults has "beginner" from old version → must not crash, must default to `.easy`
- UserDefaults has "expert" from old version → must not crash, must default to `.easy`
- UserDefaults has no value at all → must default to `.easy`
- UserDefaults has "easy", "medium", or "hard" → must load correctly

**Import note:** `CGFloat` requires `import Foundation` (already present) or `import CoreGraphics`. Verify the existing import covers it. On iOS, `Foundation` transitively includes `CoreGraphics` types, so no additional import needed.

## Reviewers

- **code-reviewer** → `logs/working/task-2/code-reviewer-{round}.json`
- **test-reviewer** → `logs/working/task-2/test-reviewer-{round}.json`

## Post-completion

- [ ] Record brief summary in decisions.md (Summary: 1-3 sentences, review with links to JSON, no tables of findings or dumps)
- [ ] If deviated from spec — describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
