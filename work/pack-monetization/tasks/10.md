---
status: planned
depends_on: [8, 9]
wave: 4
skills: [code-writing]
verify: bash
reviewers: [code-reviewer]
teammate_name:
---

# Task 10: LabyrinthListView + CompletionView -- story-complete flow

## Required Skills

Before executing this task, load:
- `/skill:code-writing` -- [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

After completing all 3 difficulty levels of a story (easy -> medium -> hard), the user should see a story-complete celebration and return to the bookshelf -- NOT advance to the next story. Currently, LabyrinthListView's `attemptNext()` simply increments `currentIndex` to move to the next labyrinth in the flat list. This task changes that flow so the last difficulty level of a story triggers a special celebration in CompletionView, and the "Next" action navigates back to the bookshelf.

This completes the user-facing story-complete flow described in the user spec: "Complete all 3 difficulty levels of a story -> story complete celebration -> back to bookshelf" (user-spec line 8).

**Prerequisite state after Tasks 8-9:** BookshelfView exists and is wired into ContentView navigation. GameViewModel has story-complete detection logic (`isLastDifficultyForStory` or similar). The grid loads labyrinths filtered by story and the current difficulty. Pack-based locking is in place.

## What to do

1. **Add a story-complete detection mechanism to LabyrinthListView.** After the current labyrinth is completed, check whether this was the last difficulty level (hard) for the current story. Use GameViewModel's story-complete detection (added in Task 9) to determine this. The check should look at the current labyrinth's difficulty -- if it is "hard", the story is complete.

2. **Add a story-complete state to LabyrinthListView.** Add a `@State private var showStoryComplete = false` flag. When the completed labyrinth is the hard level of a story, set `showStoryComplete = true` instead of showing the normal completion view (or show it after the normal completion, depending on UX flow).

3. **Update CompletionView to support story-complete mode.** Add an `isStoryComplete: Bool` parameter (default `false`). When `isStoryComplete` is true:
   - Show a special celebration header (e.g., "Story Complete!" with a trophy or star icon)
   - Change the "Next Labyrinth" button to "Back to Bookshelf" (or "Continue" -- text should reflect returning to the bookshelf)
   - Keep the character celebration and educational content visible
   - The `onNext` callback in story-complete mode should dismiss the game and navigate back to the bookshelf

4. **Update LabyrinthListView's completion flow.** In the `onComplete` handler of `LabyrinthGameView`:
   - Call `gameViewModel.completeCurrentLabyrinth()` as before
   - Check if the completed labyrinth is the hard difficulty (story complete)
   - If story complete: show CompletionView with `isStoryComplete: true` and wire `onNext` to dismiss back to bookshelf
   - If NOT story complete: show normal CompletionView with `onNext` wired to `attemptNext()` as before

5. **Update the `onNext` callback for story-complete mode.** When `isStoryComplete` and the user taps "Back to Bookshelf":
   - Stop TTS audio
   - Send analytics event `StoryComplete.backToBookshelf`
   - Call `gameViewModel.closeGame()` to dismiss the game view and return to the grid/bookshelf
   - The bookshelf should be the visible screen after dismissal (relies on ContentView navigation from Task 8)

6. **Update `attemptNext()` logic.** The current `attemptNext()` calls `gameViewModel.canProceed()` which was removed in Task 9. Replace this with the new pack-based logic from Task 9. If the user is on the last labyrinth in the list (last difficulty of last story in the loaded set), the "Next" button in normal CompletionView should behave gracefully (either disable or loop back).

## TDD Anchor

Delete this section -- this task is UI navigation and visual verification. Story-complete detection logic is tested in Task 9 (GameViewModel) and Task 11 (integration tests). The changes here are SwiftUI view wiring that cannot be meaningfully unit tested.

## Acceptance Criteria

- [ ] Completing the hard level of a story shows a story-complete celebration in CompletionView
- [ ] Story-complete CompletionView shows "Back to Bookshelf" (or similar) instead of "Next Labyrinth"
- [ ] Tapping "Back to Bookshelf" dismisses the game and returns to the bookshelf screen
- [ ] Completing easy or medium levels still shows the normal CompletionView with "Next Labyrinth"
- [ ] Normal "Next Labyrinth" still advances to the next labyrinth as before
- [ ] TTS audio stops when navigating back to bookshelf
- [ ] Analytics events fire correctly for story-complete flow
- [ ] CompletionView `isStoryComplete` parameter defaults to `false` (backward compatible)
- [ ] No references to the removed `canProceed()` method remain in LabyrinthListView
- [ ] `xcodebuild build` succeeds

## Context Files

- [user-spec.md](../user-spec.md) -- "Complete all 3 difficulty levels of a story -> story complete celebration -> back to bookshelf"
- [tech-spec.md](../tech-spec.md) -- Task 10 description, navigation architecture
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md)
- [patterns.md](~/.claude/skills/project-knowledge/references/patterns.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md)
- [LabyrinthListView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthListView.swift) -- primary file to modify: navigation logic, completion flow
- [CompletionView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/CompletionView.swift) -- add story-complete celebration mode
- [GameViewModel.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift) -- story-complete detection (added in Task 9), `closeGame()`, navigation
- [BookshelfView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/BookshelfView.swift) -- created in Task 8, navigation target after story complete
- [ContentView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ContentView.swift) -- navigation state management (updated in Task 8)
- [Labyrinth.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Models/Labyrinth.swift) -- `difficulty` field used for story-complete check

## Verification Steps

- Step 1: Run `xcodebuild build` -- must succeed with zero errors.
- Step 2: Grep LabyrinthListView.swift for `canProceed` -- must return zero matches (removed method).
- Step 3: Grep CompletionView.swift for `isStoryComplete` -- must return at least one match (new parameter).
- Step 4: Grep LabyrinthListView.swift for `showStoryComplete` or `isStoryComplete` -- must return at least one match (story-complete state).
- Step 5: Grep LabyrinthListView.swift for `closeGame` -- must return matches (back-to-bookshelf navigation).
- Step 6: Visual verification in simulator (user step): complete hard level of a story, verify celebration screen shows "Back to Bookshelf", verify tapping it returns to bookshelf.

## Details

**Files to modify:**

- `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/LabyrinthListView.swift` -- update completion flow, remove `canProceed()` usage, add story-complete branching, update `attemptNext()`
- `LowDopamineLabyrinth/LowDopamineLabyrinth/Views/CompletionView.swift` -- add `isStoryComplete` parameter, conditional UI for story-complete celebration

**Dependencies:** Tasks 8 (BookshelfView + ContentView navigation) and 9 (GameViewModel story-complete detection + pack-based locking). Both must be complete before this task.

**Key flow diagram:**

```
User completes maze
  -> gameViewModel.completeCurrentLabyrinth()
  -> Check: labyrinth.difficulty == "hard"?
     YES -> showCompletion = true, isStoryComplete = true
            CompletionView shows celebration + "Back to Bookshelf"
            onNext -> ttsService.stop() + gameViewModel.closeGame()
            -> Returns to bookshelf (via ContentView navigation)
     NO  -> showCompletion = true, isStoryComplete = false
            CompletionView shows normal "Next Labyrinth"
            onNext -> attemptNext() (advance to next labyrinth)
```

**Story-complete detection:** The simplest approach is checking `labyrinth.difficulty == "hard"` since there are exactly 3 levels per story (easy/medium/hard) and hard is always the last. This avoids needing to query the manifest or loader for level ordering. GameViewModel may also expose a computed property like `isCurrentLabyrinthLastInStory` (from Task 9) -- prefer using that if available, but `difficulty == "hard"` is the reliable fallback.

**CompletionView changes:**

```
Current:                          Story-complete mode:
+----------------------------+    +----------------------------+
| [Character celebration]    |    | [Character celebration]    |
| "Great job!"               |    | "Story Complete!"          |
| "You collected 3/5 items"  |    | "You collected 3/5 items"  |
| [Educational Q + Fun Fact] |    | [Educational Q + Fun Fact] |
| [Next Labyrinth ->]        |    | [Back to Bookshelf ->]     |
| Try Again                  |    | Try Again                  |
+----------------------------+    +----------------------------+
```

**Edge cases:**
- User taps "Try Again" on a story-complete CompletionView: should reset the maze and let them replay the hard level. If they complete it again, story-complete shows again.
- User is on the very last labyrinth in the loaded list AND it is NOT the hard level: normal "Next Labyrinth" should be handled gracefully (disable button or do nothing if at end of list).
- Current labyrinth is nil: existing guard handles this (shows "No labyrinths available").

**Paywall sheet in LabyrinthListView:** The current `attemptNext()` shows the paywall when `canProceed()` returns false. After Task 9, the free-play gating is removed. The paywall trigger moves to the grid (tapping a locked story). In LabyrinthListView, `attemptNext()` should simply advance to the next labyrinth without paywall checks -- if the user is playing, they already passed the lock check on the grid. Remove or simplify the paywall sheet logic in LabyrinthListView if it is no longer triggered from here.

**Analytics events to add/update:**
- `StoryComplete.shown` -- when story-complete celebration appears (with labyrinthId, storyNumber)
- `StoryComplete.backToBookshelf` -- when user taps "Back to Bookshelf"
- `Completion.nextTapped` -- keep existing event for normal completion flow

## Reviewers

- **code-reviewer** -> `logs/working/task-10/code-reviewer-{round}.json`

## Post-completion

- [ ] Record brief summary in decisions.md (Summary: 1-3 sentences, review with links to JSON, no findings tables or dumps)
- [ ] If deviated from spec -- describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
