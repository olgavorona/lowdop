---
status: planned
depends_on: [11]
wave: 5
skills: [pre-deploy-qa]
verify: bash
reviewers: []
teammate_name:
---

# Task 12: Pre-deploy QA

## Required Skills

Before starting, load:
- `/skill:pre-deploy-qa` -- [skills/pre-deploy-qa/SKILL.md](~/.claude/skills/pre-deploy-qa/SKILL.md)

## Description

Final acceptance testing for the entire pack-monetization feature. This task verifies that every acceptance criterion from both user-spec and tech-spec is satisfied, all content files are correct, all tests pass, the app builds cleanly, and all screens render properly in the simulator.

This is NOT a code task. No files are modified. The purpose is to systematically verify that tasks 1-11 collectively deliver the complete feature as specified. Any failures found here must be reported and fixed before the feature can ship.

## What to do

### Step 1: Run the full test suite

Run `xcodebuild test` against the full test target. All unit tests must pass with zero failures.

### Step 2: Verify content files (60 JSONs)

Check that exactly 60 maze JSON files exist with correct names (`denny_XXX_easy.json`, `denny_XXX_medium.json`, `denny_XXX_hard.json` for XXX 001-020). Verify:
- No lv2 or lv4 files exist anywhere in the bundle
- No lv1, lv3, or lv5 files exist (all renamed)
- Every JSON has `difficulty` field set to one of: "easy", "medium", "hard"
- Every JSON has `path_data.complexity` matching its `difficulty` field
- Every JSON's `id` field matches its filename (without `.json`)
- No `age_range` field in any JSON
- No "beginner" or "expert" strings in any JSON

### Step 3: Verify manifest.json

- `total` is 60
- `packs` array exists with one entry (`ocean_adventures`, `free_stories: 3`, stories 1-20)
- 60 labyrinth entries, each with a `story` field (integer 1-20)
- All difficulty values are "easy", "medium", or "hard" only

### Step 4: Verify difficulty_samples.json

- Exactly 3 keys: "easy", "medium", "hard"
- No "beginner", "expert", or old "easy"/"hard" (lv2/lv4) data

### Step 5: Verify Swift code -- no old references

- DifficultyLevel enum has exactly 3 cases (easy, medium, hard)
- No references to `beginner` or `expert` in Swift code (as difficulty level identifiers)
- No `totalFreeLabyrinthsPlayed`, `dailyLabyrinthsPlayed`, `canPlayToday`, `freeLabyrinthsRemaining` in any Swift file
- No subscription-related code remains (auto-renewal, trial periods, weekly/monthly/yearly product IDs)
- SubscriptionManager uses a single non-consumable product ID

### Step 6: Verify new screens exist and build

- `BookshelfView.swift` exists and is referenced in pbxproj
- `StoryInfo` model exists
- `ContentView` navigation includes bookshelf state

### Step 7: Build the app

Run `xcodebuild build` -- must succeed with zero errors.

### Step 8: Visual check in simulator (post-change checklist)

Build and run in the iPad Air simulator. Verify all 5 screens from the UX post-change checklist:
1. **Onboarding/difficulty picker**: 3 cards (easy/medium/hard), maze previews render, privacy policy link visible
2. **Pack picker (bookshelf)**: appears after difficulty selection, shows 1 pack card, tapping enters grid
3. **Grid screen**: characters fit inside cards, text not clipped, lock icons on stories 4-20, progress bar correct
4. **Game/maze screen**: maze fills space, characters not overlapping controls, top bar readable, nav bar usable
5. **Completion screen**: character and text properly sized, buttons accessible

Check that nothing intersects, overflows, or is incorrectly sized.

### Step 9: Verify pbxproj integrity

- All 40 deleted files (lv2/lv4) are removed from pbxproj
- All 60 renamed files are referenced in pbxproj
- BookshelfView.swift is added to pbxproj
- No orphaned file references

## Acceptance Criteria

### From user-spec:

- [ ] Onboarding shows 3 difficulty cards (easy/medium/hard) instead of 5
- [ ] New pack picker screen appears after difficulty selection
- [ ] Pack picker always displays even with a single pack
- [ ] Grid shows all 20 stories for the selected pack at the selected difficulty
- [ ] Stories 1-3 are fully playable without purchase (all 3 difficulty levels)
- [ ] Stories 4-20 show lock icon when pack is not purchased
- [ ] Tapping a locked story triggers parental gate then paywall
- [ ] Paywall shows single product: $9.99 one-time purchase
- [ ] After purchase, all stories in the pack unlock immediately
- [ ] Purchase persists across app restarts (StoreKit 2 non-consumable)
- [ ] Restore Purchases works correctly
- [ ] Completing all 3 levels of a story shows story-complete celebration
- [ ] After story-complete celebration, user returns to bookshelf
- [ ] Old subscription product IDs removed (no existing subscribers to migrate)
- [ ] 40 maze JSON files deleted (lv2 and lv4 variants)
- [ ] Remaining 60 maze files have correct difficulty names (easy/medium/hard)
- [ ] difficulty_samples.json has 3 entries (easy/medium/hard)
- [ ] App builds and runs without errors

### From tech-spec:

- [ ] DifficultyLevel enum has exactly 3 cases (easy, medium, hard)
- [ ] No references to beginner/expert in Swift code
- [ ] No lv2 or lv4 JSON files in bundle
- [ ] All remaining JSON files have correct difficulty field (easy/medium/hard)
- [ ] SubscriptionManager uses single non-consumable product ID
- [ ] No subscription-related code remains (auto-renewal, trial periods)
- [ ] Free-play tracking fully removed (no daily limits, no totalFreeLabyrinthsPlayed)
- [ ] BookshelfView renders and navigates to grid
- [ ] All unit tests pass
- [ ] No regressions in existing functionality (maze drawing, path validation, audio, completion)
- [ ] pbxproj updated: deleted files removed, new files added, renamed files updated

## Context Files

- [user-spec.md](../user-spec.md) -- all user-facing acceptance criteria
- [tech-spec.md](../tech-spec.md) -- technical acceptance criteria, architecture, data models
- [decisions.md](../decisions.md) -- any deviations recorded during implementation

## Verification Steps

### 1. Unit tests pass

```bash
xcodebuild test -project LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj -scheme LowDopamineLabyrinth -destination 'platform=iOS Simulator,id=D1CE5302-B5A3-4999-B0FE-FE96E86BA3F1' -only-testing:LowDopamineLabyrinthTests
# Expected: ** TEST SUCCEEDED **
```

### 2. Exactly 60 maze JSON files exist

```bash
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*.json | wc -l
# Expected: 60
```

### 3. Correct naming distribution (20 easy + 20 medium + 20 hard)

```bash
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*_easy.json | wc -l
# Expected: 20
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*_medium.json | wc -l
# Expected: 20
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*_hard.json | wc -l
# Expected: 20
```

### 4. No lv2/lv4 files remain

```bash
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*_lv2.json 2>/dev/null | wc -l
# Expected: 0
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*_lv4.json 2>/dev/null | wc -l
# Expected: 0
```

### 5. No old lv1/lv3/lv5 files remain

```bash
ls LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*_lv*.json 2>/dev/null | wc -l
# Expected: 0
```

### 6. No old difficulty values in JSON content

```bash
grep -rl '"beginner"' LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*.json 2>/dev/null | wc -l
# Expected: 0
grep -rl '"expert"' LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*.json 2>/dev/null | wc -l
# Expected: 0
```

### 7. No age_range field in any JSON

```bash
grep -rl 'age_range' LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/denny_*.json 2>/dev/null | wc -l
# Expected: 0
```

### 8. Manifest total is 60 with packs array and story fields

```bash
grep '"total": 60' LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/manifest.json
# Expected: matches
grep '"packs"' LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/manifest.json
# Expected: matches
grep -c '"story":' LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/manifest.json
# Expected: 60
```

### 9. difficulty_samples.json has exactly 3 keys

```bash
python3 -c "import json; d=json.load(open('LowDopamineLabyrinth/LowDopamineLabyrinth/Resources/Labyrinths/difficulty_samples.json')); print(sorted(d.keys())); assert sorted(d.keys()) == ['easy', 'hard', 'medium']"
# Expected: ['easy', 'hard', 'medium']
```

### 10. DifficultyLevel enum has exactly 3 cases

```bash
grep -n 'case.*easy.*medium.*hard' LowDopamineLabyrinth/LowDopamineLabyrinth/*.swift
# Expected: matches in UserPreferences.swift
grep -c 'case beginner\|case expert' LowDopamineLabyrinth/LowDopamineLabyrinth/*.swift
# Expected: 0
```

### 11. No free-play tracking code remains

```bash
grep -rl 'totalFreeLabyrinthsPlayed\|dailyLabyrinthsPlayed\|canPlayToday\|freeLabyrinthsRemaining' LowDopamineLabyrinth/LowDopamineLabyrinth/*.swift 2>/dev/null | wc -l
# Expected: 0
```

### 12. No subscription product IDs remain

```bash
grep -rl 'labyrinth_unlimited_weekly\|labyrinth_unlimited_monthly\|labyrinth_unlimited_yearly\|labyrinth_unlimited_lifetime' LowDopamineLabyrinth/LowDopamineLabyrinth/*.swift 2>/dev/null | wc -l
# Expected: 0
```

### 13. Non-consumable product ID exists

```bash
grep -r 'labyrinth_pack_ocean' LowDopamineLabyrinth/LowDopamineLabyrinth/*.swift
# Expected: matches in SubscriptionManager.swift
```

### 14. BookshelfView exists and is in pbxproj

```bash
ls LowDopamineLabyrinth/LowDopamineLabyrinth/BookshelfView.swift
# Expected: file exists
grep 'BookshelfView' LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj
# Expected: matches
```

### 15. No orphaned lv2/lv4 references in pbxproj

```bash
grep -c '_lv2\|_lv4' LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj/project.pbxproj
# Expected: 0
```

### 16. App builds successfully

```bash
xcodebuild build -project LowDopamineLabyrinth/LowDopamineLabyrinth.xcodeproj -scheme LowDopamineLabyrinth -destination 'platform=iOS Simulator,id=D1CE5302-B5A3-4999-B0FE-FE96E86BA3F1'
# Expected: ** BUILD SUCCEEDED **
```

### 17. Visual check (user verification)

Build and launch in iPad Air 11-inch (M3) simulator. Manually verify all 5 screens per the post-change checklist:
1. Onboarding: 3 difficulty cards fit landscape, maze previews render
2. Bookshelf: pack card visible, tapping navigates to grid
3. Grid: 20 stories, lock icons on 4-20, characters fit cards
4. Game/maze: maze fills space, controls accessible
5. Completion: character and text sized correctly

## Details

**Files:** None -- this is a verification-only task. No files are created or modified.

**Dependencies:** Task 11 (all implementation and test tasks complete)

**Edge cases:**
- Grep for "beginner"/"expert" should exclude comments that explain the migration (e.g., "formerly beginner") -- verify these are migration comments, not live code references
- Audio file references inside JSONs still use original names -- this is correct and expected (audio was not renamed)
- StoreKit testing configuration may need to be present for purchase-flow integration tests

**Implementation hints:**
- Run verification steps in order -- content files first (fast), then code checks (fast), then build (slow), then tests (slowest)
- If any step fails, record the failure clearly with the step number and actual vs expected output
- Visual check requires the simulator to be booted and the app launched -- use `xcrun simctl boot` if needed
- The post-change checklist from MEMORY.md covers all 5 screens that must be visually verified

## Reviewers

None -- QA task does not require review.

## Post-completion

- [ ] Record brief summary in decisions.md (Summary: 1-3 sentences, review with links to JSON, no findings tables or dumps)
- [ ] If any criteria failed -- list them with details for follow-up
- [ ] Update user-spec/tech-spec if anything changed
