---
status: planned
depends_on: [2]
wave: 2
skills: [code-writing]
verify: bash
reviewers: [code-reviewer, security-auditor]
teammate_name:
---

# Task 5: SubscriptionManager -- single non-consumable

## Required Skills

Before executing, load:
- `/skill:code-writing` â€” [skills/code-writing/SKILL.md](~/.claude/skills/code-writing/SKILL.md)

## Description

Replace the current multi-subscription product model in SubscriptionManager with a single non-consumable IAP for the ocean pack. The app currently defines 3 subscription product IDs (`labyrinth_unlimited_monthly`, `labyrinth_unlimited_yearly`, `labyrinth_unlimited_lifetime`) and contains subscription-specific logic (auto-renewal handling, multiple product sorting/selection). This task simplifies everything to a single non-consumable product ID `labyrinth_pack_ocean`, removing all subscription-related code while preserving the public API surface that PaywallView and GameViewModel depend on (`isPremium`, `loadProducts()`, `purchase(_:)`, `restorePurchases()`).

Non-consumable IAP means the purchase is permanent -- StoreKit 2's `Transaction.currentEntitlements` already handles this correctly, so the entitlement check logic stays largely the same but becomes simpler (one product ID instead of three).

## What to do

1. Replace the `productIds` array with a single constant: `private let productId = "labyrinth_pack_ocean"`.

2. Change `products: [Product]` to `product: Product?` (single published property instead of array). Update `loadProducts()` to request a single product ID and assign to `product`.

3. Update `checkEntitlements()` to check for the single `productId` only. Remove the comment about "auto-renewable subscriptions and non-consumable (lifetime)" -- this is now purely a non-consumable check.

4. Update `purchase(_:)` -- no logic changes needed, but verify it works correctly with a non-consumable product (StoreKit 2 handles both the same way).

5. Keep `restorePurchases()` exactly as-is -- `AppStore.sync()` + `checkEntitlements()` works for non-consumables.

6. Keep the `listenForTransactions()` listener -- it handles ownership changes (refunds, family sharing) for non-consumables too.

7. Keep `StoreError.failedVerification` and `checkVerified` -- verification is critical for non-consumable products.

8. Remove the sorting logic in `loadProducts()` (`.sorted { $0.price < $1.price }`) -- there is only one product.

## TDD Anchor

Tests in `LowDopamineLabyrinthTests/SubscriptionManagerTests.swift`:

- `test_productId_is_labyrinth_pack_ocean` -- the product ID constant equals `"labyrinth_pack_ocean"`
- `test_isPremium_defaults_to_false` -- new SubscriptionManager starts with `isPremium == false`
- `test_product_defaults_to_nil` -- new SubscriptionManager starts with `product == nil`

Note: Full StoreKit purchase flow testing (product loading, purchase, entitlement check) requires Xcode's StoreKit testing configuration and will be covered in Task 11. These TDD anchors verify the static/default state only.

## Acceptance Criteria

- [ ] `productIds` array replaced with single `productId = "labyrinth_pack_ocean"`
- [ ] `products: [Product]` replaced with `product: Product?`
- [ ] No references to `labyrinth_unlimited_monthly`, `labyrinth_unlimited_yearly`, `labyrinth_unlimited_lifetime`
- [ ] No subscription-specific comments or logic (auto-renewal, trial, subscription period)
- [ ] `isPremium`, `loadProducts()`, `purchase(_:)`, `restorePurchases()` remain as public API
- [ ] `checkEntitlements()` checks for the single non-consumable product ID
- [ ] `listenForTransactions()` preserved for handling ownership changes
- [ ] `checkVerified()` and `StoreError.failedVerification` preserved for purchase verification
- [ ] Compatibility shim `var products: [Product]` computed property added (wraps single product in array for PaywallView compatibility until Task 7)
- [ ] xcodebuild builds successfully

## Context Files

- [user-spec.md](../user-spec.md) -- acceptance criteria: "Paywall shows single product: $9.99 one-time purchase", "Old subscription product IDs removed"
- [tech-spec.md](../tech-spec.md) -- architecture: SubscriptionManager uses single non-consumable, `Transaction.currentEntitlements`
- [decisions.md](../decisions.md)
- [project.md](~/.claude/skills/project-knowledge/references/project.md)
- [architecture.md](~/.claude/skills/project-knowledge/references/architecture.md)
- [code-research.md](../code-research.md)
- [SubscriptionManager.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Services/SubscriptionManager.swift) -- the file being modified
- [PaywallView.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/Views/PaywallView.swift) -- caller, uses products/purchase/loadProducts/restorePurchases
- [GameViewModel.swift](../../../LowDopamineLabyrinth/LowDopamineLabyrinth/ViewModels/GameViewModel.swift) -- caller, uses isPremium only

## Verification Steps

- Step 1: Build the project with xcodebuild. Expected: BUILD SUCCEEDED.
- Step 2: Grep SubscriptionManager.swift for old product IDs. Expected: zero matches for `labyrinth_unlimited`.
- Step 3: Grep SubscriptionManager.swift for `labyrinth_pack_ocean`. Expected: at least one match.
- Step 4: Grep SubscriptionManager.swift for `auto-renew` or `subscription`. Expected: zero matches.

## Details

**Files to modify:** `LowDopamineLabyrinth/LowDopamineLabyrinth/Services/SubscriptionManager.swift`

**Dependencies:** Task 2 (DifficultyLevel enum changes) must be complete -- though SubscriptionManager does not directly depend on DifficultyLevel, the build must succeed with the modified UserPreferences.

**Callers to keep compatible:**
- PaywallView accesses `subscriptionManager.products` (array) -- changing to `product: Product?` will cause PaywallView to fail to compile. This is expected and acceptable: PaywallView is rewritten in Task 7 (Wave 3, depends on this task). During this task, PaywallView compilation errors are expected. The build may fail at PaywallView until Task 7 is completed.
- GameViewModel accesses `subscriptionManager.isPremium` -- no change needed, this property is preserved.

**Approach to build verification:** Since changing `products: [Product]` to `product: Product?` will break PaywallView (which references `subscriptionManager.products`), there are two options:
1. Temporarily add a computed `products` compatibility shim so PaywallView still compiles, to be removed in Task 7.
2. Accept that the build will fail until Task 7 completes.

**Required:** Option 1 -- add a computed property `var products: [Product] { product.map { [$0] } ?? [] }` so the build passes at each task boundary. Task 7 removes it when PaywallView is rewritten. This shim is MANDATORY for the build to succeed, since PaywallView references `subscriptionManager.products` at 4 call sites.

**Edge cases:**
- Product not found in App Store Connect: `loadProducts()` should handle empty result gracefully (product remains nil)
- `purchase()` signature takes a `Product` parameter -- callers must pass the single product. No API change needed.

**Security considerations:**
- `checkVerified()` must remain -- it rejects unverified transactions, which is the primary defense against receipt tampering
- `listenForTransactions()` must remain -- it catches refunds and revocations
- No server-side validation is used (client-only StoreKit 2), which is acceptable for this app's threat model (kids maze game, $9.99 non-consumable)

## Reviewers

- **code-reviewer** -> `logs/working/task-5/code-reviewer-{round}.json`
- **security-auditor** -> `logs/working/task-5/security-auditor-{round}.json`

## Post-completion

- [ ] Record brief report in decisions.md (Summary: 1-3 sentences, review with links to JSON, no tables of findings or dumps)
- [ ] If deviated from spec -- describe deviation and reason
- [ ] Update user-spec/tech-spec if anything changed
